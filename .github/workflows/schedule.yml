name: Car Market Alert - Scheduled

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instala o pandas e requests diretamente para garantir
          pip install pandas requests beautifulsoup4
          # Se existir um requirements.txt em qualquer pasta, instala também
          find . -name "requirements.txt" -exec pip install -r {} +

      - name: Run alert script
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MIN_PRICE: "5000"
          MAX_PRICE: "30000"
          ALERT_MARGIN: "0.15"
          RATE_LIMIT: "0.5"
        run: |
          # Este comando encontra o caminho real do main.py e executa-o
          MAIN_PATH=$(find . -name "main.py" | head -n 1)
          echo "A executar: $MAIN_PATH"
          export PYTHONPATH=$PYTHONPATH:$(dirname $MAIN_PATH)
          python $MAIN_PATH

      - name: Commit updated market history
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main
          # Encontra o CSV e adiciona-o, onde quer que esteja
          CSV_FILE=$(find . -name "market.csv" | head -n 1)
          if [ -n "$CSV_FILE" ]; then
            git add $CSV_FILE
            git commit -m "Update market history [skip ci]" || echo "Sem alterações"
            git push origin main || echo "Falha no push"
          fi
