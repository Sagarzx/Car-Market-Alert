name: Car Market Alert - Scheduled

on:
  schedule:
    - cron: "*/15 * * * *"   # Corre a cada 15 minutos
  workflow_dispatch: {}       # Permite correr manualmente

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Garante que temos o histórico para evitar erros de push

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r market_watch/requirements.txt
          # Se não usares Playwright nos novos scrapers de requests, podes comentar a linha abaixo para poupar tempo
          # python -m playwright install --with-deps chromium

      - name: Prepare data dir
        run: mkdir -p market_watch/data

      - name: Run alert script
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          ROLLING_DAYS: "30"
          ALERT_MARGIN: "0.15"            # 15% abaixo da média = Alerta de Lucro
          DROP_THRESHOLD_PCT: "0.05"
          DROP_THRESHOLD_ABS: "250"
          MIN_PRICE: "5000"
          MAX_PRICE: "30000"              # Aumentei para teres mais margem de análise
          MAX_KM: "200000"
          RATE_LIMIT: "0.5"               # Mais lento (1 pedido a cada 2s) evita bloqueios
          LOG_LEVEL: "INFO"
        run: |
          # Adicionamos o diretório ao PYTHONPATH para o Python encontrar o módulo corretamente
          export PYTHONPATH=$PYTHONPATH:$(pwd)/market_watch
          python -m market_watch.main

      - name: Commit updated market history
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main # Evita erros de conflito se o CSV mudou
          git add market_watch/data/market.csv || true
          git commit -m "Update market history [skip ci]" || true
          git push origin main || true
